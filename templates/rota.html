<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <title>Rota</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }

        #mapaContainer {
            position: relative;
        }

        canvas {
            border: 1px solid #000;
            background-color: #fff;
        }

        button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #zoomButtons {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        #zoomButtons button {
            margin: 5px;
            padding: 5px 10px;
            font-size: 16px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #andarDisplay {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1000;
        }

        #btnVoltar {
            position: absolute;
            top: 20px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <h1>Rota para <span id="destinoDisplay"></span></h1>
    <div id="mapaContainer">
        <select id="andarDisplay"></select>

        <canvas id="mapaCanvas" width="800" height="600"></canvas>
        <div id="zoomButtons">
            <button id="zoomInButton">+</button>
            <button id="zoomOutButton">-</button>
        </div>
    </div>
    <button id="btnVoltar" onclick="window.location.href='/salas'"><span
            class="material-symbols-outlined">undo</span></button>

    <script>

        function verificaAndar(andar) {
            if (andar == 0) {
                valor = 'Terreo';
            } else if (andar == 1) {
                valor = 'Primeiro';
            } else if (andar == 2) {
                valor = 'Segundo';
            } else if (andar == 'MB') {
                valor = 'MB';
            } else if (andar == 'MB1') {
                valor = 'MB1';
            } else if (andar == 'MB2') {
                valor = 'MB2'
            }

            return valor;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const andarDisplay = document.getElementById('andarDisplay')
            const rotaCompleta = JSON.parse(localStorage.getItem('rota')) || [];
            const arestas = JSON.parse(localStorage.getItem('arestas')) || [];
            const andar = JSON.parse(localStorage.getItem('andares')) || [];
            const destino = localStorage.getItem('destino');
            const zoomInButton = document.getElementById('zoomInButton');
            const zoomOutButton = document.getElementById('zoomOutButton');
            let verifica = 0;
            let scale = 1;
            let currentFloor = verificaAndar(andar[0]);
            let rota = [];
            let validaAndar = 0;
            let subiu = 0;
            let mb = 0;

            document.getElementById('destinoDisplay').textContent = destino;

            const canvas = document.getElementById('mapaCanvas');
            const ctx = canvas.getContext('2d');

            // Variáveis para panning
            let isPanning = false;
            let startX = 0;
            let startY = 0;
            let offsetX = 0;
            let offsetY = 0;

            // Evento para iniciar o panning
            /*canvas.addEventListener('mousedown', (e) => {
                isPanning = true;
                startX = e.clientX - offsetX;
                startY = e.clientY - offsetY;
            });

            // Evento para parar o panning
            canvas.addEventListener('mouseup', () => {
                isPanning = false;
            });

            canvas.addEventListener('mouseout', () => {
                isPanning = false;
            });

            // Evento para mover o canvas durante o panning
            canvas.addEventListener('mousemove', (e) => {
                if (isPanning) {
                    offsetX = e.clientX - startX;
                    offsetY = e.clientY - startY;
                    draw();
                }
            });

            // Eventos de toque para panning em dispositivos móveis
            canvas.addEventListener('touchstart', function (e) {
                isDragging = true;
                const touch = e.touches[0];
                dragStartX = touch.clientX - offsetX;
                dragStartY = touch.clientY - offsetY;
            });

            canvas.addEventListener('touchmove', function (e) {
                if (isDragging) {
                    const touch = e.touches[0];
                    offsetX = touch.clientX - dragStartX;
                    offsetY = touch.clientY - dragStartY;
                    draw();
                }
            });

            canvas.addEventListener('touchend', function () {
                isDragging = false;
            });

            // Eventos de zoom
            zoomInButton.addEventListener('click', function () {
                scale *= 1.2; // Aumenta a escala
                draw();
            });

            zoomOutButton.addEventListener('click', function () {
                scale /= 1.2; // Diminui a escala
                draw();
            });*/

            // Definindo as posições das salas para diferentes andares
            const positions = {
            "Terreo": {
                "Portaria": [400, 550],
                "C0": [400, 500],
                "TI": [350, 500],
                "Xerox": [266, 500],
                "Lab. Info. Geral": [200, 550],
                "Escada A": [150, 500],
                "Escada B": [565, 119],
                "Escada C": [650, 220],
                "Escada D": [650, 500],
                "Escada F": [295, 40],
                "Elevador": [325, 40],
                "C1": [200, 500],
                "C2": [200, 465],
                "C3": [200, 409],
                "C4": [200, 353],
                "C5": [200, 325],
                "C6": [200, 298],
                "C7": [200, 271],
                "C8": [200, 222],
                "C9": [200, 173],
                "Ref./Cantina": [200, 150],
                "C10": [255, 150],
                "C11": [360, 150],
                "C12": [400, 150],
                "C13": [565, 150],
                "Biblioteca": [600, 150],
                "C14": [600, 185],
                "C15": [600, 220],
                "C16": [600, 325],
                "C17": [600, 409],
                "C18": [600, 465],
                "C19": [600, 500],
                "C20": [565, 500],
                "C21": [255, 119],
                "C22": [255, 71],
                "C23": [295, 71],
                "C24": [325, 71],
                "C25": [255, 10],
                "WC/Vest. M": [150, 222],
                "WC/Vest. F": [150, 173],
                "WC Familia": [360, 119],
                "WC Cantina": [305, 119],
                "Sala Prof.": [400, 119],
                "Sala Prof. 1": [150, 298],
                "Sala Prof. 2": [150, 271],
                "Centro": [400, 325],
                "Sala Estágio": [565, 550],
                "Pastoral": [150, 465],
                "Diretoria": [150, 409],
                "Lab. AutoCad": [150, 353],
                "Social": [650, 465],
                "Secretaria": [650, 409],
                "Coordenação": [650, 325],
                "Cant. Leitura": [650, 185],
                "Quadra": [100, 150],
                "Sala Arquivo": [360, 71],
                "Capela": [150, 550],
                "Corredor S.J.": [100, 325],
                "Estacionamento": [500, 10],
                "Entrada Prédio M.B.": [130, 10],
            },
            "Primeiro": {
                "Escada A": [150, 500],
                "Escada B": [565, 119],
                "Escada C": [650, 220],
                "Escada D": [650, 500],
                "Escada F": [295, 40],
                "Elevador": [325, 40],
                "C26": [180, 500],
                "C27": [230, 380],
                "C28": [230, 285],
                "C29": [230, 227],
                "C30": [230, 156],
                "C31": [230, 85],
                "C32": [325, 85],
                "C33": [270, 85],
                "C34": [295, 85],
                "C35": [360, 85],
                "C36": [395, 85],
                "C37": [430, 85],
                "C38": [475, 85],
                "C38.1": [475, 40],
                "C39": [520, 85],
                "C40": [565, 85],
                "C41": [620, 85],
                "C42": [620, 120],
                "C43": [620, 220],
                "C44": [620, 275],
                "C45": [620, 323],
                "C46": [620, 371],
                "C47": [620, 419],
                "C48": [620, 467],
                "C49": [620, 500],
                "C50": [515, 500],
                "C51": [425, 500],
                "C52": [335, 500],
                "C53": [255, 500],
                "Sala Infra": [180, 475],
                "Salão do Juri": [230, 500],
                "Obs. V.E.": [650, 467],
                "Audio Visual": [650, 85],
                "Auditorio": [230, 40],
                "Banheiro M": [445, 40],
                "Banheiro F": [505, 40],
                "Sala C2": [200, 380],
                "Sala C3": [200, 285],
                "Sala C4": [200, 227],
                "Sala E2": [650, 419],
                "Sala E3": [650, 371],
                "Sala E4": [650, 323],
                "Sala E5": [650, 275],
                "DD101": [270, 40],
                "DD102": [200, 156],
                "DD104": [360, 120],
                "DD105": [620, 40],
                "DD106": [520, 120],
                "DD107": [650, 120],
                "DD109": [430, 120],
                "DD110": [395, 40],
                "Lab.03": [255, 525],
                "Lab.04": [335, 525],
                "Lab.05": [425, 525],
                "Lab.06": [515, 525],
            },
            "Segundo": {
                "Escada F": [295, 40],
                "Elevador": [325, 40],
                "C28": [50, 500],
                "Sala 301": [100, 400],
            },
            "MB": {
                "Entrada Prédio M.B.": [400, 500],
                "Oficina/Aero Unisal": [400, 200],
                "C101": [400, 410],
                "Lab. Mec./Projeto": [330, 410],
                "Saida Prédio M.B.": [480, 410],
                "C102": [400, 375],
                "Escada M.B.": [480, 375],
                "C103": [400, 340],
                "Lab. Mecanica": [330, 340],
                "Elevador M.B.": [480, 340],
                "C104": [400, 285],
                "Banheiros": [480, 285],
                "C105": [560, 410],
                "Lab. Civil": [560, 100],
                "C106": [330, 100],
                "Estacionamento": [630, 285],
            },
            "MB1": {
                "Escada M.B.": [480, 375],
                "Elevador M.B.": [480, 340],
                "C107": [400, 375],
                "C108": [400, 340],
                "C109": [400, 295],
                "C110": [400, 240],
                "MB07": [400, 175],
                "MB08": [320, 340],
                "MB09": [400, 445],
                "LMI":  [480, 295],
                "Banheiros 1":  [480, 240],
            },
            "MB2":{
                "Escada M.B.": [480, 375],
                "Elevador M.B.": [480, 340],
                "C111": [400, 375],
                "C112": [400, 340],
                "C113": [400, 260],
                "C114": [400, 180],
                "MB01": [400, 435],
                "MB02": [370, 465],
                "MB03": [320, 340],
                "MB04": [320, 260],
                "MB05/MB06": [400, 100],
                "Banheiros 2": [480, 180],
            }
        };

            let changePositions = []

            // Resetando o dropdown list

            andarDisplay.innerHTML = '<option value="Terreo">Térreo</option>'

            for (let i = 1; i < andar.length; i++) {
                if (andar[i] !== andar[i - 1]) {
                    changePositions.push(i);

                    andarDisplay.innerHTML += `<option value="${verificaAndar(andar[i])}" id="${andar[i]}">${verificaAndar(andar[i])}</option>`

                }
            }

            // Função para desenhar o mapa
            function draw() {
                let verifica = andar.length; // Inicializa verifica com o valor padrão (comprimento do array)

                for (let i = 1; i < andar.length; i++) {
                    if (andar[i] !== andar[i - 1]) {
                        verifica = i; // Atualiza verifica quando encontrar uma diferença
                        break;
                    }
                }

                let destinoFinal = andar.length - 1

                if (currentFloor == "Terreo") {
                    if ((andar[destinoFinal] == 0 || andar[destinoFinal] == 1) && subiu == 0) {
                        rota = rotaCompleta.slice(0, verifica);
                        subiu = 0;

                    } else if (andar[destinoFinal] == 2 && subiu == 0) {
                        if (currentFloor == "Terreo") {
                            rota = rotaCompleta.slice(0, verifica);
                            subiu = 1
                        }

                    } else if ((andar[destinoFinal] == "MB" || andar[destinoFinal] == "MB1" || andar[destinoFinal] == "MB2") && subiu == 0) {
                        if (currentFloor == "Terreo") {
                            rota = rotaCompleta.slice(0, verifica);

                        } else {
                            rota = rotaCompleta.slice(changePositions[1] - 1);
                            subiu = 1

                        }

                    } else {
                        if (andar[destinoFinal] == 2) {
                            currentFloor = "Segundo";
                            rota = rotaCompleta.slice(verifica - 1);

                        } else if (andar[destinoFinal] == 1) {
                            currentFloor = "Terreo";
                            rota = rotaCompleta.slice(0, verifica);

                        } else if (andar[destinoFinal] == "MB") {
                            currentFloor = "Terreo";
                            rota = rotaCompleta.slice(0, verifica);

                        } else if (andar[destinoFinal] == "MB1" || andar[destinoFinal] == "MB2") {
                            currentFloor = "Terreo"
                            rota = rotaCompleta.slice(0, verifica);

                        }

                        subiu = 0;

                    }

                } else if (currentFloor == "Primeiro") {
                    if (andar[destinoFinal] == 1 && subiu == 0) {
                        rota = rotaCompleta.slice(verifica - 1);
                        subiu = 1

                        console.log(rota);

                    } else {
                        rota = rotaCompleta.slice(0, verifica);
                        subiu = 0
                    }

                } else if (currentFloor == "Segundo") {
                    if (andar[destinoFinal] == 2 && subiu == 0) {
                        rota = rotaCompleta.slice(verifica - 1);
                        subiu = 1

                    } else {
                        rota = rotaCompleta.slice(verifica - 1);
                        subiu = 0
                    }

                } else if (currentFloor == "MB") {
                    if ((andar[destinoFinal] == 'MB1' || andar[destinoFinal] == 'MB2')) {
                        rota = rotaCompleta.slice(changePositions[0] - 1, changePositions[1]);
                        subiu = 0

                    } else {
                        rota = rotaCompleta.slice(verifica - 1);
                    }

                } else if (currentFloor == "MB1" || currentFloor == "MB2") {
                    rota = rotaCompleta.slice(changePositions[1] - 1);
                    subiu = 1

                }

                ctx.clearRect(0, 0, canvas.width, canvas.height); // Limpa o canvas

                // Aplica o deslocamento
                ctx.save();
                ctx.translate(offsetX, offsetY);
                ctx.scale(scale, scale);

                // Desenhar as arestas
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 1;

                console.log(currentFloor);
                
                arestas.forEach(([u, v, weight]) => {
                    if (positions[currentFloor][u] && positions[currentFloor][v]) {
                        const [x1, y1] = positions[currentFloor][u];
                        const [x2, y2] = positions[currentFloor][v];
                        ctx.beginPath();
                        ctx.moveTo(x1 + 10, y1 + 10);
                        ctx.lineTo(x2 + 10, y2 + 10);
                        ctx.stroke();
                    }
                });

                // Desenhar as salas
                ctx.fillStyle = 'lightgrey';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;

                Object.keys(positions[currentFloor]).forEach(key => {
                    const [x, y] = positions[currentFloor][key];
                    const width = 20;
                    const height = 20;
                    const centerX = x + width / 2;
                    const centerY = y + height / 2;

                    const isNotCPlusNumber = !/^C\d/.test(key);

                    // if (isNotCPlusNumber) {
                    if (true == true) {

                        // Verificar se é uma escada e mudar a cor para verde se estiver na rota
                        if (rota.includes(key) && (key.startsWith('Escada') || key.startsWith('Entrada') || key.startsWith('Elevador'))) {
                            ctx.fillStyle = 'green';

                            // Tornar a escada clicável apenas se estiver na rota
                            canvas.addEventListener('click', function clickHandler(event) {
                                const rect = canvas.getBoundingClientRect();
                                const clickX = event.clientX - rect.left;
                                const clickY = event.clientY - rect.top;

                                if (
                                    clickX >= x + offsetX &&
                                    clickX <= x + offsetX + width &&
                                    clickY >= y + offsetY &&
                                    clickY <= y + offsetY + height
                                ) {

                                    if (key.startsWith('Escada') || key.startsWith('Elevador')) {

                                        if (andar[destinoFinal] == 0) {
                                            currentFloor = 'Terreo'

                                        } else if (andar[destinoFinal] == 1 || andar[destinoFinal] == 2) {
                                            if (validaAndar == 0) {
                                                if (andar[destinoFinal] == 2) {
                                                    currentFloor = 'Segundo';
                                                } else {
                                                    currentFloor = 'Primeiro';
                                                }
                                                validaAndar = 1;
                                            } else {
                                                currentFloor = 'Terreo'
                                                validaAndar = 0;

                                            }


                                        } else if (andar[destinoFinal] == "MB") {
                                            if (validaAndar == 0) {
                                                currentFloor = 'MB';
                                                validaAndar = 1;
                                            } else {
                                                currentFloor = 'Terreo'
                                                validaAndar = 0
                                            }

                                        } else if (andar[destinoFinal] == "MB1" || andar[destinoFinal] == "MB2") {
                                            if (validaAndar == 0) {
                                                if (andar[destinoFinal] == "MB1") {
                                                    currentFloor = 'MB1';
                                                } else {
                                                    currentFloor = 'MB2';
                                                }

                                                validaAndar = 1;
                                            } else {
                                                currentFloor = 'MB'
                                                validaAndar = 0
                                            }
                                        } else {
                                            if (validaAndar == 0) {
                                                currentFloor = 'Segundo';
                                                validaAndar = 1;
                                            } else {
                                                currentFloor = 'Terreo'
                                                validaAndar = 0;

                                            }
                                        }

                                    } else if (key.startsWith('Entrada')) {
                                        if (mb == 0) {
                                            currentFloor = 'MB'
                                            mb = 1
                                        } else {
                                            currentFloor = 'Terreo'
                                            mb = 0
                                        }
                                    }

                                    document.getElementById(currentFloor).selected = true;

                                    draw();

                                }
                            });

                        } else {
                            ctx.fillStyle = 'lightgrey';
                        }

                        ctx.beginPath();
                        ctx.rect(x, y, width, height);
                        ctx.fill();
                        ctx.stroke();

                        ctx.fillStyle = 'black';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        ctx.fillText(key, centerX, y);
                        ctx.fillStyle = 'lightgrey';
                    }
                });

                // Desenha a rota com uma linha vermelha
                if (rota.length > 0) {
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 5;
                    ctx.beginPath();

                    const start = positions[currentFloor][rota[0]];

                    ctx.moveTo(start[0] + 10, start[1] + 10);

                    rota.slice(1).forEach(room => {
                        const point = positions[currentFloor][room];
                        ctx.lineTo(point[0] + 10, point[1] + 10);
                    });

                    ctx.stroke();

                    // Desenha a seta na ponta da rota
                    const [endX, endY] = positions[currentFloor][rota[rota.length - 1]];
                    const [startX, startY] = positions[currentFloor][rota[rota.length - 2]];
                    drawArrow(ctx, startX + 10, startY + 10, endX + 10, endY + 10);

                }

                ctx.restore();
            }

            function drawArrow(ctx, startX, startY, endX, endY, arrowSize = 20) {
                const angle = Math.atan2(endY - startY, endX - startX);

                ctx.fillStyle = 'red';
                ctx.beginPath();
                ctx.moveTo(endX, endY);
                ctx.lineTo(
                    endX - arrowSize * Math.cos(angle - Math.PI / 6),
                    endY - arrowSize * Math.sin(angle - Math.PI / 6)
                );
                ctx.lineTo(
                    endX - arrowSize * Math.cos(angle + Math.PI / 6),
                    endY - arrowSize * Math.sin(angle + Math.PI / 6)
                );
                ctx.closePath();
                ctx.fill();
            }

            andarDisplay.addEventListener('change', setAndar);

            draw();

            function setAndar() {
                const andarSelecionado = andarDisplay.value;
                // Atualiza o andar atual
                currentFloor = andarSelecionado;
                
                draw(); // Redesenha o canvas
            }
        });
    </script>
</body>

</html>