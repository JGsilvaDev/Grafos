<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rota</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }

        #mapaContainer {
            position: relative;
        }

        canvas {
            border: 1px solid #000;
            background-color: #fff;
        }

        button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Rota para <span id="destinoDisplay"></span></h1>
    <div id="mapaContainer">
        <canvas id="mapaCanvas" width="800" height="600"></canvas>
    </div>
    <button onclick="window.location.href='/'">Voltar</button>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const rota = JSON.parse(localStorage.getItem('rota')) || [];
            const arestas = JSON.parse(localStorage.getItem('arestas')) || [];
            const destino = localStorage.getItem('destino');
            document.getElementById('destinoDisplay').textContent = destino;

            const canvas = document.getElementById('mapaCanvas');
            const ctx = canvas.getContext('2d');

            // Definindo as posições das salas
            const positions = {
                "Portaria": [400, 550],
                "C0": [400, 500],
                "TI": [100, 100],
                "Xerox": [200, 200],
                "C1": [300, 200],
                "Lab. Info. Geral": [400, 200],
                "Escada A": [500, 200],
                "C2": [300, 300],
                "C3": [400, 300],
                "C4": [500, 300],
                "C5": [600, 300],
                "C6": [700, 300],
                "C7": [800, 300],
                "C8": [900, 300],
                "C9": [1000, 300],
                "Ref./Cantina": [500, 400],
                "C10": [600, 400],
                "C11": [700, 400],
                "C12": [800, 400],
                "C13": [900, 400],
                "Biblioteca": [1000, 400],
                "C14": [600, 500],
                "C15": [700, 500],
                "C16": [800, 500],
                "C17": [900, 500],
                "C18": [1000, 500],
                "C19": [1100, 500],
                "C20": [1200, 500],
                "C21": [600, 600],
                "C22": [700, 600],
                "C23": [800, 600],
                "C24": [900, 600],
                "C25": [1000, 600],
                "Estacionamento": [1100, 600],
                "Prédio M.B.": [1200, 600],
                "WC/Vest. M": [800, 700],
                "WC/Vest. F": [900, 700],
                "Sala Prof. 1": [700, 700],
                "Sala Prof. 2": [800, 700],
                "Sala Estágio": [100, 500]
            };

            // Desenhando as arestas
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 15;
            arestas.forEach(([u, v, weight]) => {
                if (positions[u] && positions[v]) {
                    const [x1, y1] = positions[u];
                    const [x2, y2] = positions[v];
                    ctx.beginPath();
                    ctx.moveTo(x1 + 10, y1 + 10);
                    ctx.lineTo(x2 + 10, y2 + 10);
                    ctx.stroke();
                }
            });

            // Desenhando as salas
            ctx.fillStyle = 'lightgrey';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;

            Object.keys(positions).forEach(key => {
                // Verificar se a sala não é C + número
                // if (!/^C\d+$/.test(key)) {
                const [x, y] = positions[key];
                const width = 20;
                const height = 20;
                const centerX = x + width / 2;
                const centerY = y + height / 2;

                ctx.beginPath();
                ctx.rect(x, y, width, height);
                ctx.fill();
                ctx.stroke();

                // Ajusta o texto para ficar em cima da sala
                ctx.fillStyle = 'black';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom'; // Texto alinhado no meio do retângulo
                ctx.fillText(key, centerX, y); // Texto posicionado em cima da sala
                ctx.fillStyle = 'lightgrey'; // Reset color for next rectangle
                // }
            });

            // Desenhando a rota com uma linha vermelha
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 5;
            ctx.beginPath();

            if (rota.length > 0) {
                // Começa na primeira sala da rota
                const start = positions[rota[0]];
                const startX = start[0] + 10; // Centro do retângulo
                const startY = start[1] + 10; // Centro do retângulo
                ctx.moveTo(startX, startY);

                // Desenha o caminho
                rota.forEach(sala => {
                    const [x, y] = positions[sala];
                    const xCenter = x + 10; // Centro do retângulo
                    const yCenter = y + 10; // Centro do retângulo
                    ctx.lineTo(xCenter, yCenter);
                });

                ctx.stroke();

                // Adiciona a seta no destino final
                const [endX, endY] = positions[rota[rota.length - 1]];

                const arrowSize = 25;
                const angle = Math.atan2(endY - (rota.length > 1 ? positions[rota[rota.length - 2]][1] : endY), endX - (rota.length > 1 ? positions[rota[rota.length - 2]][0] : endX));

                ctx.fillStyle = 'red';
                ctx.beginPath();
                ctx.moveTo(endX + 20, endY + 20);
                ctx.lineTo(endX + 20 - arrowSize * Math.cos(angle - Math.PI / 6), endY + 20 - arrowSize * Math.sin(angle - Math.PI / 6));
                ctx.lineTo(endX + 20 - arrowSize * Math.cos(angle + Math.PI / 6), endY + 20 - arrowSize * Math.sin(angle + Math.PI / 6));
                ctx.closePath();
                ctx.fill();
            }
        });
    </script>
</body>

</html>